<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chinamobile.hnu.xiangyu.club.dao.ClubInfoMapper">
	<resultMap id="BaseResultMap"
		type="com.chinamobile.hnu.xiangyu.club.pojo.ClubInfo">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Thu May 17 
			23:34:42 CST 2018. -->
		<id column="id" jdbcType="INTEGER" property="id" />
		<result column="gmt_create" jdbcType="TIMESTAMP" property="gmtCreate" />
		<result column="gmt_modified" jdbcType="TIMESTAMP" property="gmtModified" />
		<result column="name" jdbcType="VARCHAR" property="name" />
		<result column="logo_image" jdbcType="VARCHAR" property="logoImage" />
		<result column="creator" jdbcType="INTEGER" property="creator" />
		<result column="member_number" jdbcType="INTEGER" property="memberNumber" />
		<result column="cover_image" jdbcType="VARCHAR" property="coverImage" />
		<result column="introduction" jdbcType="VARCHAR" property="introduction" />
		<result column="qrcode_image" jdbcType="VARCHAR" property="qrcodeImage" />
		<result column="yesterday_traffic" jdbcType="INTEGER" property="yesterdayTraffic" />
		<result column="setting_visible" jdbcType="TINYINT" property="settingVisible" />
		<result column="setting_speak" jdbcType="TINYINT" property="settingSpeak" />
		<result column="setting_activity" jdbcType="TINYINT" property="settingActivity" />
		<result column="setting_notice" jdbcType="TINYINT" property="settingNotice" />
		<result column="setting_vote" jdbcType="TINYINT" property="settingVote" />
		<result column="status" jdbcType="TINYINT" property="status" />
		<result column="collection_number" jdbcType="INTEGER" property="collectionNumber" />
		<result column="college" jdbcType="VARCHAR" property="college" />
	</resultMap>
	<sql id="Base_Column_List">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Thu May 17 
			23:34:42 CST 2018. -->
		id, gmt_create, gmt_modified, name, logo_image, creator,
		member_number, cover_image,
		introduction, qrcode_image,
		yesterday_traffic, setting_visible, setting_speak,
		setting_activity,
		setting_notice, setting_vote, status, collection_number,college
	</sql>
	<select id="selectByPrimaryKey" parameterType="java.lang.Integer"
		resultMap="BaseResultMap">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Thu May 17 
			23:34:42 CST 2018. -->
		select
		<include refid="Base_Column_List" />
		from club_info
		where id = #{id,jdbcType=INTEGER}
	</select>
	<delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Thu May 17 
			23:34:42 CST 2018. -->
		delete from club_info
		where id = #{id,jdbcType=INTEGER}
	</delete>
	<insert id="insert" parameterType="com.chinamobile.hnu.xiangyu.club.pojo.ClubInfo"
		useGeneratedKeys="true" keyProperty="id">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Thu May 17 
			23:34:42 CST 2018. -->
		insert into club_info (id, gmt_create,
		name, logo_image, creator,
		cover_image,qrcode_image
		)
		values (#{id,jdbcType=INTEGER},
		#{gmtCreate,jdbcType=TIMESTAMP},
		#{name,jdbcType=VARCHAR},
		#{logoImage,jdbcType=VARCHAR},
		#{creator,jdbcType=INTEGER},
		#{coverImage,jdbcType=VARCHAR},#{qrcodeImage,jdbcType=VARCHAR}
		)
	</insert>
	<insert id="insertSelective" parameterType="com.chinamobile.hnu.xiangyu.club.pojo.ClubInfo"
		useGeneratedKeys="true" keyProperty="id">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Thu May 17 
			23:34:42 CST 2018. -->
		insert into club_info
		<trim prefix="(" suffix=")" suffixOverrides=",">
			<if test="id != null">
				id,
			</if>
			<if test="gmtCreate != null">
				gmt_create,
			</if>
			<if test="gmtModified != null">
				gmt_modified,
			</if>
			<if test="name != null">
				name,
			</if>
			<if test="logoImage != null">
				logo_image,
			</if>
			<if test="creator != null">
				creator,
			</if>
			<if test="memberNumber != null">
				member_number,
			</if>
			<if test="coverImage != null">
				cover_image,
			</if>
			<if test="introduction != null">
				introduction,
			</if>
			<if test="qrcodeImage != null">
				qrcode_image,
			</if>
			<if test="yesterdayTraffic != null">
				yesterday_traffic,
			</if>
			<if test="settingVisible != null">
				setting_visible,
			</if>
			<if test="settingSpeak != null">
				setting_speak,
			</if>
			<if test="settingActivity != null">
				setting_activity,
			</if>
			<if test="settingNotice != null">
				setting_notice,
			</if>
			<if test="settingVote != null">
				setting_vote,
			</if>
			<if test="status != null">
				status,
			</if>
			<if test="collectionNumber != null">
				collection_number,
			</if>
			<if test="college != null">
				college,
			</if>
		</trim>
		<trim prefix="values (" suffix=")" suffixOverrides=",">
			<if test="id != null">
				#{id,jdbcType=INTEGER},
			</if>
			<if test="gmtCreate != null">
				#{gmtCreate,jdbcType=TIMESTAMP},
			</if>
			<if test="gmtModified != null">
				#{gmtModified,jdbcType=TIMESTAMP},
			</if>
			<if test="name != null">
				#{name,jdbcType=VARCHAR},
			</if>
			<if test="logoImage != null">
				#{logoImage,jdbcType=VARCHAR},
			</if>
			<if test="creator != null">
				#{creator,jdbcType=INTEGER},
			</if>
			<if test="memberNumber != null">
				#{memberNumber,jdbcType=INTEGER},
			</if>
			<if test="coverImage != null">
				#{coverImage,jdbcType=VARCHAR},
			</if>
			<if test="introduction != null">
				#{introduction,jdbcType=VARCHAR},
			</if>
			<if test="qrcodeImage != null">
				#{qrcodeImage,jdbcType=VARCHAR},
			</if>
			<if test="yesterdayTraffic != null">
				#{yesterdayTraffic,jdbcType=INTEGER},
			</if>
			<if test="settingVisible != null">
				#{settingVisible,jdbcType=TINYINT},
			</if>
			<if test="settingSpeak != null">
				#{settingSpeak,jdbcType=TINYINT},
			</if>
			<if test="settingActivity != null">
				#{settingActivity,jdbcType=TINYINT},
			</if>
			<if test="settingNotice != null">
				#{settingNotice,jdbcType=TINYINT},
			</if>
			<if test="settingVote != null">
				#{settingVote,jdbcType=TINYINT},
			</if>
			<if test="status != null">
				#{status,jdbcType=TINYINT},
			</if>
			<if test="collectionNumber != null">
				#{collectionNumber,jdbcType=INTEGER},
			</if>
			<if test="college != null">
				#{college}
			</if>
		</trim>
	</insert>
	<update id="updateByPrimaryKeySelective" parameterType="com.chinamobile.hnu.xiangyu.club.pojo.ClubInfo">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Thu May 17 
			23:34:42 CST 2018. -->
		update club_info
		<set>
			<if test="gmtModified != null">
				gmt_modified = #{gmtModified,jdbcType=TIMESTAMP},
			</if>
			<if test="name != null">
				name = #{name,jdbcType=VARCHAR},
			</if>
			<if test="logoImage != null">
				logo_image = #{logoImage,jdbcType=VARCHAR},
			</if>
			<if test="memberNumber != null">
				member_number = #{memberNumber,jdbcType=INTEGER},
			</if>
			<if test="coverImage != null">
				cover_image = #{coverImage,jdbcType=VARCHAR},
			</if>
			<if test="introduction != null">
				introduction = #{introduction,jdbcType=VARCHAR},
			</if>
			<if test="qrcodeImage != null">
				qrcode_image = #{qrcodeImage,jdbcType=VARCHAR},
			</if>
			<if test="yesterdayTraffic != null">
				yesterday_traffic = #{yesterdayTraffic,jdbcType=INTEGER},
			</if>
			<if test="settingVisible != null">
				setting_visible = #{settingVisible,jdbcType=TINYINT},
			</if>
			<if test="settingSpeak != null">
				setting_speak = #{settingSpeak,jdbcType=TINYINT},
			</if>
			<if test="settingActivity != null">
				setting_activity = #{settingActivity,jdbcType=TINYINT},
			</if>
			<if test="settingNotice != null">
				setting_notice = #{settingNotice,jdbcType=TINYINT},
			</if>
			<if test="settingVote != null">
				setting_vote = #{settingVote,jdbcType=TINYINT},
			</if>
			<if test="status != null">
				status = #{status,jdbcType=TINYINT},
			</if>
			<if test="collectionNumber != null">
				collection_number = #{collectionNumber,jdbcType=INTEGER},
			</if>
		</set>
		where id = #{id,jdbcType=INTEGER}
	</update>
	<update id="updateByPrimaryKey" parameterType="com.chinamobile.hnu.xiangyu.club.pojo.ClubInfo">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Thu May 17 
			23:34:42 CST 2018. -->
		update club_info
		set gmt_create = #{gmtCreate,jdbcType=TIMESTAMP},
		gmt_modified = #{gmtModified,jdbcType=TIMESTAMP},
		name =
		#{name,jdbcType=VARCHAR},
		logo_image = #{logoImage,jdbcType=VARCHAR},
		creator = #{creator,jdbcType=INTEGER},
		member_number =
		#{memberNumber,jdbcType=INTEGER},
		cover_image =
		#{coverImage,jdbcType=VARCHAR},
		introduction =
		#{introduction,jdbcType=VARCHAR},
		qrcode_image =
		#{qrcodeImage,jdbcType=VARCHAR},
		yesterday_traffic =
		#{yesterdayTraffic,jdbcType=INTEGER},
		setting_visible =
		#{settingVisible,jdbcType=TINYINT},
		setting_speak =
		#{settingSpeak,jdbcType=TINYINT},
		setting_activity =
		#{settingActivity,jdbcType=TINYINT},
		setting_notice =
		#{settingNotice,jdbcType=TINYINT},
		setting_vote =
		#{settingVote,jdbcType=TINYINT},
		status = #{status,jdbcType=TINYINT},
		collection_number = #{collectionNumber,jdbcType=INTEGER}
		where id =
		#{id,jdbcType=INTEGER}
	</update>

	<update id="updateCollection">
		update club_info
		<set>
			<choose>
				<when test="type == 1">
					collection_number = collection_number+1
				</when>
				<otherwise>
					collection_number = collection_number-1
				</otherwise>
			</choose>
		</set>
		where id = #{clubId,jdbcType=BIGINT}
	</update>

	<update id="updateMember">
		update club_info
		<set>
			<choose>
				<when test="type == 1">
					member_number = member_number+1
				</when>
				<otherwise>
					member_number = member_number-1
				</otherwise>
			</choose>
		</set>
		where id = #{clubId,jdbcType=INTEGER}
	</update>


	<!-- type 1：热门团队；2：最新的团队；3：我的团队；4：收藏;5.推荐的团队;6我创建的 -->
	<select id="selectByPage" parameterType="map"
		resultType="com.chinamobile.hnu.xiangyu.club.vo.ClubVo">


		<choose>
			<when test="type == 5">
				
				<if test="school == null">
					(SELECT t1.id,t1.name,t1.logo_image as
				logoImage,t1.creator,t1.member_number as
				memberNumber,t1.introduction,
				t1.setting_speak as settingSpeak,
				t1.setting_activity AS
				settingActivity,t1.college,
				t2.nickname as
				creatorName
				from club_info t1 left join user_account t2 on t1.creator
				= t2.id
				left join club_label t3 on t1.id = t3.club_id
				where
				t1.setting_visible = 0 and t1.status = 0
				and t3.name in
				<foreach collection="labels" item="item" open="(" close=")"
					separator=",">
					#{item.label}
				</foreach>
				order by t1.yesterday_traffic desc)
				</if>
				
				<if test="school != null">
				(SELECT t1.id,t1.name,t1.logo_image as
				logoImage,t1.creator,t1.member_number as
				memberNumber,t1.introduction,
				t1.setting_speak as settingSpeak,
				t1.setting_activity AS
				settingActivity,t1.college,
				t2.nickname as
				creatorName
				from club_info t1 left join user_account t2 on t1.creator
				= t2.id
				left join club_label t3 on t1.id = t3.club_id
				where
				t1.setting_visible = 0 and t1.status = 0
				and t3.name in
				<foreach collection="labels" item="item" open="(" close=")"
					separator=",">
					#{item.label}
				</foreach>
					<!-- 不加LIMIT排序会不起作用 -->
					and t1.college = #{school} order by t1.id desc LIMIT 99999999999)

					UNION

					(SELECT t1.id,t1.name,t1.logo_image as
					logoImage,t1.creator,t1.member_number as
					memberNumber,t1.introduction,
					t1.setting_speak as settingSpeak,
					t1.setting_activity AS
					settingActivity,t1.college,
					t2.nickname as creatorName
					from club_info t1 left join user_account t2 on t1.creator = t2.id
					left join club_label t3 on t1.id = t3.club_id
					where
					t1.setting_visible = 0 and t1.status = 0
					and t3.name in
					<foreach collection="labels" item="item" open="(" close=")"
						separator=",">
						#{item.label}
					</foreach>
					order by t1.id desc LIMIT 99999999999
					)
				</if>
			</when>
			<otherwise>
				SELECT t1.id,t1.name,t1.logo_image as
				logoImage,t1.creator,t1.member_number as
				memberNumber,t1.introduction,
				t1.setting_speak as settingSpeak,
				t1.setting_activity AS
				settingActivity,t1.setting_visible as
				settingVisible,t1.college,
				t2.nickname as creatorName
				from club_info
				t1 left join user_account t2 on t1.creator = t2.id
				<choose>
					<when test="type == 1">
						where
						t1.setting_visible = 0 and t1.status = 0
						<if test="idList != null">
							and t1.id in
							<foreach collection="idList" item="id" open="(" close=")"
								separator=",">
								#{id}
							</foreach>
						</if>

						<if test="keyword != null">
							and t1.name like CONCAT("%",(#{keyword}),"%")
						</if>
						<choose>
							<when test="idList != null">
							 order by field(t1.id,
							 <foreach collection="idList" item="id"
								separator=",">
								#{id}
							</foreach>
							 )
							</when>
							<otherwise>
								order by t1.yesterday_traffic desc,t1.collection_number desc
							</otherwise>
						</choose>
					</when>
					<when test="type == 2">
						where
						t1.setting_visible = 0 and t1.status = 0
						<if test="idList != null">
							and t1.id in
							<foreach collection="idList" item="id" open="(" close=")"
								separator=",">
								#{id}
							</foreach>
						</if>
						<if test="keyword != null">
							and t1.name like CONCAT("%",(#{keyword}),"%")
						</if>
						
						<choose>
							<when test="idList != null">
							 order by field(t1.id,
							 <foreach collection="idList" item="id"
								separator=",">
								#{id}
							</foreach>
							 )
							</when>
							<otherwise>
								order by t1.gmt_create desc
							</otherwise>
						</choose>
					</when>
					<when test="type == 3">
						right join club_member t3 on t1.id = t3.club_id and t3.member_id =
						#{uid}
						WHERE t1.id IS NOT NULL and t1.status = 0
						<if test="keyword != null">
							and t1.name like CONCAT("%",(#{keyword}),"%")
						</if>
						order by t3.join_time desc
					</when>
					<when test="type == 4">
						right join user_favorite t3 on t1.id = t3.biz_id and t3.user_id =
						#{uid} and t3.category = 2
						WHERE t1.id IS NOT NULL and t1.status =
						0
						<if test="keyword != null">
							and t1.name like CONCAT("%",(#{keyword}),"%")
						</if>
						order by t3.gmt_create desc
					</when>
					<when test="type == 6">
						WHERE  t1.status = 0
						and t1.creator = #{uid}
						<if test="keyword != null">
							and t1.name like CONCAT("%",(#{keyword}),"%")
						</if>
						order by t1.gmt_create desc
					</when>
				</choose>

			</otherwise>

		</choose>

	</select>


	<update id="updateYesterdayTrafficByList" parameterType="list">
		<foreach collection="list" item="item" separator=";">
			update
			club_info set yesterday_traffic = #{item.countNumber} where id =
			#{item.clubId}
		</foreach>
	</update>

	<update id="updateYesterdayTrafficToZero">
		update club_info set yesterday_traffic = 0
	</update>

	<select id="selectByIdList" parameterType="java.util.Set"
		resultType="com.chinamobile.hnu.xiangyu.club.vo.ClubVo">
		SELECT t1.id,t1.name,t1.logo_image as
		logoImage,t1.creator,t1.member_number as
		memberNumber,t1.introduction,t1.college,
		t2.nickname as creatorName
		from club_info t1 left join user_account t2
		on t1.creator = t2.id
		<where>
			t1.id in
			<foreach collection="set" item="id" open="(" close=")"
				separator=",">
				#{id,jdbcType=INTEGER}
			</foreach>
			and t1.status = 0
		</where>
	</select>

	<select id="selectByclubList" resultType="com.chinamobile.hnu.xiangyu.web.api.vo.AclubVo"
		parameterType="map">
		SELECT
		t1.id,
		t1.name,
		t1.status,
		t1.gmt_create as gmtCreate,t1.college,
		t2.nickname
		as nn,
		t2.id as uid
		FROM
		club_info t1
		LEFT JOIN user_account t2
		on t2.id = t1.creator
		where 1=1
		<if test="name != null and name != ''">
			and t1.name LIKE concat( '%',#{name},'%' )
		</if>
		<if test="college != null and college != ''">
			and t1.college LIKE concat( '%',#{college},'%' )
		</if>
		<if test="status != null and status != ''">
			and t1.status = #{status}
		</if>
		<if test="startTime != null and endTime == null and startTime != '' and endTime == ''">
			and t1.gmt_create = #{startTime}
		</if>
		<if test="endTime != null and startTime == null and endTime != '' and startTime == ''">
			and t1.gmt_create = #{endTime}
		</if>
		<if test="startTime != null and endTime != null and startTime != '' and  endTime != ''">
			and t1.gmt_create <![CDATA[>=]]>
			#{startTime}
			and t1.gmt_create <![CDATA[<=]]>
			#{endTime}
		</if>
		ORDER BY t1.gmt_create desc
	</select>

	<select id="selectClubInfoByclubId" resultType="com.chinamobile.hnu.xiangyu.web.api.vo.AclubInfoVo"
		parameterType="java.lang.Integer"> SELECT
		t1.id,
		t1.gmt_create AS
		gmtCreate,
		t1.gmt_modified
		AS gmtModified,
		t1. NAME,
		t1.logo_image AS
		logoImage,
		t1.creator,
		t1.member_number AS memberNumber,
		t1.cover_image
		AS coverImage,
		t1.introduction,
		t1.qrcode_image AS qrcodeImage,
		t1.yesterday_traffic AS
		yesterdayTraffic,
		t1.setting_visible AS
		settingVisible,
		t1.setting_speak
		AS settingSpeak,
		t1.setting_activity AS
		settingActivity,
		t1.setting_notice AS settingNotice,
		t1.setting_vote AS
		settingVote,
		t1.
		STATUS,
		t1.collection_number AS collectionNumber,t1.college,
		(SELECT
		count(*) FROM
		club_speak WHERE club_id = #{clubId}) AS
		speakCount,
		(SELECT count(*)
		FROM club_activity WHERE club_id =
		#{clubId}) AS
		activityCount,
		(SELECT
		count(*) FROM club_notice WHERE
		club_id =
		#{clubId}) AS noticeCount,
		(SELECT count(*) FROM
		club_vote_info WHERE
		club_id = #{clubId} ) AS
		voteCount,
		(SELECT
		count(*) FROM
		club_team_building WHERE club_id =
		#{clubId}) AS
		bulidingCount,
		t2.nickname
		FROM
		club_info t1
		LEFT JOIN
		user_account t2 ON t2.id =
		t1.creator
		WHERE
		t1.id = #{clubId}
	</select>

	<select id="selectByLabelPage" resultType="com.chinamobile.hnu.xiangyu.club.vo.ClubVo"
		parameterType="map">

		<if test="school != null">
			(
			SELECT t2.id,t2.name,t2.logo_image as
			logoImage,t2.creator,t2.member_number
			as memberNumber,t2.introduction,
			t2.setting_speak as settingSpeak,
			t2.setting_activity AS
			settingActivity,t2.college,
			t3.nickname as creatorName
			from
			club_label t1 left join
			club_info t2 on t1.club_id = t2.id
			left join
			user_account t3 on
			t2.creator = t3.id
			where
			t2.setting_visible = 0 and t2.status = 0
			and
			t1.name = #{label} and t2.college = #{school}
			group by t2.id order by t2.yesterday_traffic desc
			)
			UNION
		</if>
		(SELECT t2.id,t2.name,t2.logo_image as
		logoImage,t2.creator,t2.member_number
		as memberNumber,t2.introduction,
		t2.setting_speak as settingSpeak,
		t2.setting_activity AS
		settingActivity,t2.college,
		t3.nickname as creatorName
		from
		club_label t1
		left join
		club_info t2 on t1.club_id = t2.id
		left join
		user_account t3 on
		t2.creator = t3.id
		where
		t2.setting_visible = 0 and t2.status = 0
		and
		t1.name = #{label}

		group by t2.id order by t2.yesterday_traffic desc)
	</select>


	<select id="selectByGzhPage" parameterType="map"
		resultType="com.chinamobile.hnu.xiangyu.club.vo.ClubVo">



		SELECT t1.id,t1.name,t1.logo_image as
		logoImage,t1.creator,t1.member_number as
		memberNumber,t1.introduction,
		t1.setting_speak as settingSpeak,
		t1.setting_activity AS
		settingActivity,t1.setting_visible as settingVisible,t1.college,
		t2.nickname as creatorName
		from club_info t1 left join user_account t2 on t1.creator = t2.id
		where
		t1.setting_visible = 0 and t1.status = 0
		order by t1.yesterday_traffic desc,t1.collection_number desc


	</select>


   <select id="selectClubInfoByMap" parameterType="map" resultMap="BaseResultMap">
   	select id from club_info
   	where status = 0
   	<if test="name != null">
   		and name = #{name}
   	</if>
   	<if test="college != null">
   		and college = #{college}
   	</if>
   	
   </select>


</mapper>